export const dynamic = 'force-dynamic'; // cache kapalı

async function fetchProducts(searchParams: any = {}) {
  const page  = Number(searchParams.page ?? 1);
  const limit = 50;
  const q     = searchParams.q ?? '';
  const category = searchParams.category ?? '';

  const params = new URLSearchParams({ page: String(page), limit: String(limit) });
  if (q) params.set('q', q);
  if (category) params.set('category', category);
  // default: only fetch products that have at least one image unless explicitly asked
  if (searchParams.show !== 'all') params.set('has_image', '1');

  const base = process.env.NEXT_PUBLIC_API_BASE || 'http://127.0.0.1:5000';
  try {
    const res = await fetch(`${base}/admin-api/products?${params}`, { cache: 'no-store' });
    if (!res.ok) throw new Error('Failed to fetch products');
    return res.json();
  } catch (e) {
    // Backend may be down during local dev — return safe fallback
    return { items: [], total: 0, page: page };
  }
}

import ProductCard from '../components/ProductCard2';
import Link from 'next/link';
import CategoryFilter from '../components/CategoryFilter';

async function getCategories(){
  const base = process.env.NEXT_PUBLIC_API_BASE || 'http://127.0.0.1:5000';
  try {
    const r = await fetch(`${base}/admin-api/categories`, { cache: 'no-store' });
    if (!r.ok) return [];
    const { items } = await r.json();
    return items;
  } catch (e) {
    return [];
  }
}

export default async function AllRugsPage({ searchParams }: { searchParams?: any }) {
  const params = await searchParams;
  const data = await fetchProducts(params);
  // fetch a definitive total for the applied filters so UI shows accurate count
  // Use Next proxy so server-side rendering goes through the same path we tested
  // Must be an absolute origin on the server; empty string produces invalid URL.
  const proxyBase = process.env.NEXT_PUBLIC_PROXY_ORIGIN || 'http://127.0.0.1:3000';
  const countParams = new URLSearchParams();
  if (params.q) countParams.set('q', params.q);
  if (params.category) countParams.set('category', params.category);
  if (params.show !== 'all') countParams.set('has_image', '1');
  // default to public active listing
  countParams.set('status', 'active');
  countParams.set('visibility', 'public');
  countParams.set('count_only', '1');
  const countRes = await fetch(`${proxyBase}/api/admin-api/products?${countParams}`, { cache: 'no-store' });
  const countJson = countRes.ok ? await countRes.json() : { total: data.total };
  const totalCount = countJson.total ?? data.total;
  const totalPages = Math.ceil(totalCount / 50);
  const currentPage = Number(params.page ?? 1);
  const categories = await getCategories(); // filtre barı için

  return (
    <main className="p-6">
      <h1 className="text-2xl font-semibold mb-2">All Rugs <span id="total-count" data-total={totalCount} className="text-gray-600">({totalCount})</span></h1>
      <p className="text-sm text-gray-500 mb-6">Page {data.page} / {totalPages}</p>
      <CategoryFilter categories={categories} />
      <div className="mb-4">
        <Link href="/categories" className="text-blue-600 hover:underline">Explore our collections</Link>
      </div>
      <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
        {data.items.map((p: any) => <ProductCard key={p.product_id} product={p} />)}
      </div>
      <div className="flex gap-2 justify-center mt-4">
        {Array.from({ length: totalPages }, (_, i) => (
          <a
            key={i+1}
            href={`/all-rugs?page=${i+1}`}
            className={`px-3 py-1 rounded ${currentPage === i+1 ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'} hover:bg-blue-500 hover:text-white transition`}
          >
            {i+1}
          </a>
        ))}
      </div>
    </main>
  );
}
// single copy kept



